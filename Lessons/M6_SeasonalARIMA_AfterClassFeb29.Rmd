---
title: "M6: Seasonal ARIMA Models in R"
author: "Luana Lima"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

## Setting R code chunk options

First R code chunk is used for setting the options for all R code chunks. The choice echo=TRUE means both code and output will appear on report, include = FALSE neither code nor output is printed.

```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo = TRUE,tidy.opts=list(width.cutoff=80), tidy=FALSE) 
```

## Loading packages and initializing

Second R code chunk is for loading packages. By setting message = FALSE, the code will appear but not the output. 

```{r package, message=FALSE}
library(lubridate)
library(ggplot2)
library(forecast)  
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(cowplot)

```

## Importing data

For this module we will work with monthly average for electricity retail price in US. The data is from the U.S. Energy Information Administration and can be download [here][https://www.eia.gov/electricity/data/browser/#/topic/7?agg=2,0,1&geo=g&freq=M%2013:41:41%20GMT-0500%20(EST)]. 

```{r}

#Importing time series data from text file#
electricity_price <- read.csv(file="./Data/Average_retail_price_of_electricity_United_States_monthly.csv",header=TRUE,skip=4)

#Inspect data
head(electricity_price)
nvar <- ncol(electricity_price) - 1
nobs <- nrow(electricity_price)

#Preparing the data - create date object and rename columns
electricity_price_processed <-
  electricity_price %>%
  mutate( Month = my(Month) ) %>% 
  rename( All.sectors = all.sectors.cents.per.kilowatthour ) %>% 
  rename( Residential = residential.cents.per.kilowatthour ) %>% 
  rename( Commercial = commercial.cents.per.kilowatthour ) %>% 
  rename( Industrial = industrial.cents.per.kilowatthour ) %>% 
  arrange( Month )

head(electricity_price_processed)
summary(electricity_price_processed)

#No NAs so we don't need to worry about missing values

```

## How to deal with missing rows but not NAs

Our data goes from January 2001 to November 2022. I will remove a couple rows randonmly and show you how to detect missing rows.

```{r}

drop_rows_price <- electricity_price_processed %>% 
  select(Month,Residential) %>% 
  filter(Month != "2001-07-01" & Month != "2005-07-01")

#Create TSA object
ts_drop_rows_price <- ts(drop_rows_price$Residential, frequency=12)
tail(ts_drop_rows_price)

#Notice date end in september and not november!!

#Create a data vector with all observations from January 2001 to November 2022
#Make sure you use month month steps
Days <- as.data.frame(seq.Date(from=as.Date("2001/01/01"),to=as.Date("2022/11/01"), by ="month"))
colnames(Days) <- "Month"

#merge with the data with missing rows
new_price <-left_join(Days, drop_rows_price, by="Month")

#You should be able to see NAs for the dates missing in drop_rows_price 

```



## Transforming data into time series object

Many of the functions we will use require a time series object. You can transform your data in a time series using the function *ts()*. 

```{r}
ts_electricity_price <- ts(electricity_price_processed[,2:(nvar+1)],
                           start=c(year(electricity_price_processed$Month[1]),month(electricity_price_processed$Month[1])),
                           frequency=12) 
#note that we are only transforming columns with electricity price, not the date columns  
head(ts_electricity_price,15)
tail(ts_electricity_price,15)

```

## Initial Plots

```{r}

#ACF and PACF plots

plot_grid(
  autoplot(Acf(electricity_price_processed$Residential, lag = 40, plot=FALSE), 
                main = "ACF Residential Electricity Price"),
  autoplot(Pacf(electricity_price_processed$Residential, lag = 40, plot=FALSE),  
                  main = "PACF Residential Electricity Price")
)

```


## Decomposing the time series 

The plots from the previous section show the data has a seasonal component. Since we are working with non-seasonal ARIMA, we need to decompose the series and eliminate the seasonality.

```{r}
#Using R decompose function
decompose_residential_price <- decompose(ts_electricity_price[,"Residential"],"additive")
plot(decompose_residential_price)

#The ACF plot show a slow decay which is a sign of non-stationarity.

```

This time we will not remove seasonality to enter the Arima(). But we still need to remove seasonal component to run stationarity test and find the order of the non-seasonal part of the ARIMA, i.e., (p,d,q).


## Modeling the non-seasonal part

Remember from previous scripts that the electricity price series has a stochastic trend. A useful function to help determine how many times you should difference your series is the ndiffs() from package 'forecast'.

```{r}
#Creating non-seasonal residential price time series
deseasonal_residential_price <- seasadj(decompose_residential_price)  

# Find out how many time we need to difference
n_diff <- ndiffs(deseasonal_residential_price)
cat("Number of differencing needed: ",n_diff)

#Lets difference the series once at lag 1 to remove the trend.
deseasonal_residential_price_diff <- diff(deseasonal_residential_price,differences=1,lag=1)

#Comparing ACFs
plot_grid(
  autoplot(Acf(ts_electricity_price[,"Residential"], lag = 40, plot=FALSE), 
                main = "Orginal Residential Electricity Price"),
  autoplot(Acf(deseasonal_residential_price, lag = 40, plot=FALSE),  
                  main = "Deseason Residential Electricity Price"),
  autoplot(Acf(deseasonal_residential_price_diff, lag = 40, plot=FALSE),  
                  main = "Diff/Deseason Residential Electricity Price"),
  nrow=1
)

#Comparing PACFs
plot_grid(
  autoplot(Pacf(ts_electricity_price[,"Residential"], lag = 40, plot=FALSE), 
                main = "Orginal Residential Electricity Price"),
  autoplot(Pacf(deseasonal_residential_price, lag = 40, plot=FALSE),  
                  main = "Deseason Residential Electricity Price"),
  autoplot(Pacf(deseasonal_residential_price_diff, lag = 40, plot=FALSE),  
                  main = "Diff/Deseason Residential Electricity Price"),
  nrow=1
)
```

## Modeling the seasonal part

I will not cover the hypothesis test associated with deterministic and stochastic seasonal component. We will use the nsdiffs() function to find if our series need differencing at the seasonal lag or not. The function will run the statistical tests internally. 

```{r}
# Find out how many time we need to difference
ns_diff <- nsdiffs(ts_electricity_price[,"Residential"])
cat("Number of seasonal differencing needed: ",ns_diff)

#Lets difference the series once at lag 12 to remove the seasonal trend.
residential_price_seas_diff <- diff(ts_electricity_price[,"Residential"],lag=12, differences=1)
residential_price_trend_diff <- diff(ts_electricity_price[,"Residential"],lag =1, differences=1) #diff done on orig series
residential_price_both_diff <- diff(residential_price_trend_diff,lag =12, differences=1)

#Comparing ACFs
plot_grid(
  autoplot(Acf(ts_electricity_price[,"Residential"], lag = 40, plot=FALSE), 
                main = "Orginal Residential Electricity Price"),
  autoplot(Acf(residential_price_seas_diff, lag = 40, plot=FALSE),  
                  main = "Seasonal-Differenced Residential"),
  autoplot(Acf(residential_price_trend_diff, lag = 40, plot=FALSE),  
                  main = "Trend-Differenced Residential"),
  autoplot(Acf(residential_price_both_diff, lag = 40, plot=FALSE),  
                  main = "Twice-Differenced Residential"),
  nrow=2
)

#Comparing PACFs
plot_grid(
  autoplot(Pacf(ts_electricity_price[,"Residential"], lag = 40, plot=FALSE), 
                main = "Orginal Residential Electricity Price"),
  autoplot(Pacf(residential_price_seas_diff, lag = 40, plot=FALSE),  
                  main = "Seasonal-Differenced Residential"),
  autoplot(Pacf(residential_price_trend_diff, lag = 40, plot=FALSE),  
                  main = "Trend-Differenced Residential"),
  autoplot(Pacf(residential_price_both_diff, lag = 40, plot=FALSE),  
                  main = "Twice-Differenced Residential"),
  nrow=2
)


#Plot ACF and PACF for twice-differenced series - Steps 3 (order of non-seasonal) and 5 ) order of seasonal
plot_grid(
  autoplot(Acf(residential_price_both_diff,lag.max=60,plot=FALSE),main="Twice-Differenced Residential",ylim=c(-1,1)),
  autoplot(Pacf(residential_price_both_diff,lag.max=60,plot=FALSE),main="Twice-Differenced Residential",ylim=c(-1,1)),
  nrow=1
)


```


## Manually fitting seasonal ARIMA to original series

```{r}
Model1 <- Arima(ts_electricity_price[,"Residential"],order=c(1,1,1),seasonal=c(0,1,1),include.drift=FALSE)
print(Model1)

plot_grid(
  autoplot(Model1$residuals),
  autoplot(Acf(Model1$residuals,lag.max=40, plot = FALSE)),
  autoplot(Pacf(Model1$residuals,lag.max=40, plot = FALSE)),
  nrow=1
)

```

## Automatically fitting seasonal ARIMA to original series

```{r}

Model2 <- auto.arima(ts_electricity_price[,"Residential"])
print(Model2)

plot_grid(
  autoplot(Model2$residuals),
  autoplot(Acf(Model2$residuals,lag.max=40, plot = FALSE)),
  autoplot(Pacf(Model2$residuals,lag.max=40, plot = FALSE)),
  nrow=1
)


autoplot(ts_electricity_price[,"Residential"],series="Original")+
  autolayer(Model1$fitted,series="ARIMA(1,1,1)(0,1,1)")+
  autolayer(Model2$fitted,series="ARIMA(2,0,0)(0,1,1)")


```


## Automatically fitting ARIMA to deseasonal series

Recall from M5 that the best fit for the non-seasonal time series is a ARIMA(2,1,2) with drift.

```{r}



```

## Discussion: Which one to do? ARIMA or SARIMA?

